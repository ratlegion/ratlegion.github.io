<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>

<body>
    <script>
        let layers = []

        let awaitingLoads = [];

        let sourceTiles = {};

        async function initialiseTileset(source, id) {
            awaitingLoads.push(id + "." + source);

            try {
                await new Promise((resolve) => {
                    const initImg = new Image();
                    initImg.src = source;


                    console.log("Tileset load request sent")

                    initImg.onload = () => {
                        //TODO: fix redundant code below
                        const index = awaitingLoads.indexOf(id + "." + source);
                        awaitingLoads.splice(index, 1);

                        sourceTiles[id] = { "img": initImg };

                        console.log("Tileset " + id + " loaded")

                        resolve()
                    };

                    initImg.onerror = (error) => {
                        const index = awaitingLoads.indexOf(id + "." + source);
                        awaitingLoads.splice(index, 1);

                        console.error("Failure to load tileset " + id, error)
                    }
                });
            } catch (error) {
                const index = awaitingLoads.indexOf(id + "." + source);
                awaitingLoads.splice(index, 1);

                console.error("Error while loading tileset " + id, error)
            }
        }



        const tileCanvas = document.createElement("canvas");
        tileCanvas.width = 480;
        tileCanvas.height = 360;
        tileCanvas.style = "image-rendering: crisp-edges;";
        document.body.appendChild(tileCanvas);
        let tileCTX = tileCanvas.getContext("2d");

        function drawTile(id, index, x, y) {
            const tileSize = 16; //Hardcoded for now
            const tileScale = 1.0; //Hardcoded for now
            const tilesetWidth = 8; //Hardcoded for now

            tileCTX.drawImage(
                sourceTiles[id].img,
                ((index - 1) % tilesetWidth) * tileSize,
                Math.floor((index - 1) / tilesetWidth) * tileSize,
                tileSize, tileSize,
                x, y,
                tileSize, tileSize
            );
        }
        function drawTilesheet(tiles) {
            const tileSize = 16;
            for (let i = 0; i < tiles.length; i++) {
                for (let ii = 0; ii < tiles[i].length; ii++) {
                    const currentIndex = tiles[i][ii];
                    if (currentIndex !== 0) drawTile("grasslands", tiles[i][ii], ii * tileSize, i * tileSize);
                }
            }
        }

        async function loadGame(features, func) {
            const activeScene = 0;
            layers = features.scenes[0].layers;

            requestAnimationFrame(gameLoop);

            func()
        }


        let timeOld = performance.now();
        const targetFrameRate = 60;
        const timestep = 1000 / targetFrameRate;
        function gameLoop(currentTime) {
            const dT = currentTime - timeOld;

            if (dT >= timestep) {
                timeOld = currentTime;
                gameUpdate(dT);
            }

            requestAnimationFrame(gameLoop);
        }


        function gameUpdate(dT) {

            drawGame()
            console.log("Drawn")

        }

        function drawGame() {
            tileCTX.clearRect(0, 0, tileCanvas.width, tileCanvas.height)

            for (let i = 0; i < layers.length; i++) {
                drawTilesheet(layers[i].tiles)
            }
        }
    </script>

    <script type="module">
        await initialiseTileset("src/tileset.png", "grasslands")

        //initialiseActor("src/player.png", "player")

        //initialiseActor("src/enemy.png", "enemy")

        await loadGame({
            scenes: [
                {
                    width: 10,
                    height: 10,
                    layers: [
                        {
                            tileset: "grasslands",
                            tiles: [
                                [1, 2, 2, 2, 2, 3],
                                [9, 10, 10, 10, 10, 11],
                                [17, 18, 18, 18, 18, 19],
                                [25, 26, 26, 26, 26, 27],
                                [25, 26, 26, 26, 26, 27],
                                [25, 26, 26, 26, 26, 27],
                                [33, 34, 34, 34, 34, 35],
                                [10, 10, 10, 10, 10, 10]
                            ]

                        },
                        {
                            tileset: "grasslands",
                            tiles: [
                                [0],
                                [0, 0, 0, 4],
                            ]
                        }
                    ],
                    actors: []
                }
            ]
        },
            () => {
            })
    </script>
</body>

</html>