<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>

<body>
    <script>
        const mod = (a, b) => ((a % b) + b) % b;
        const get4Direction = rotation => [3, 1, 0, 2][Math.floor(((rotation % 360) + 360) % 360 / 90)];

        let awaitingLoads = [];

        let assets = { tiles: {}, actors: {} };

        async function initialiseTileset(source, id) {
            awaitingLoads.push(id + "." + source);

            try {
                await new Promise((resolve) => {
                    const initImg = new Image();
                    initImg.src = source;


                    console.log("Tileset load request sent")

                    initImg.onload = () => {
                        //TODO: fix redundant code below
                        const index = awaitingLoads.indexOf(id + "." + source);
                        awaitingLoads.splice(index, 1);

                        assets.tiles[id] = { "img": initImg };

                        console.log("Tileset " + id + " loaded");

                        resolve();
                    };

                    initImg.onerror = (error) => {
                        const index = awaitingLoads.indexOf(id + "." + source);
                        awaitingLoads.splice(index, 1);

                        console.error("Failure to load tileset " + id, error);
                    }
                });
            } catch (error) {
                const index = awaitingLoads.indexOf(id + "." + source);
                awaitingLoads.splice(index, 1);

                console.error("Error while loading tileset " + id, error);
            }
        }
        async function initialiseActor(source, id) {
            awaitingLoads.push(id + "." + source);

            try {
                await new Promise((resolve) => {
                    const initImg = new Image();
                    initImg.src = source;


                    console.log("Actor load request sent")

                    initImg.onload = () => {
                        //TODO: fix redundant code below
                        const index = awaitingLoads.indexOf(id + "." + source);
                        awaitingLoads.splice(index, 1);

                        assets.actors[id] = { img: initImg, width: initImg.width, height: initImg.width };

                        console.log("Actor " + id + " loaded");

                        resolve();
                    };

                    initImg.onerror = (error) => {
                        const index = awaitingLoads.indexOf(id + "." + source);
                        awaitingLoads.splice(index, 1);

                        console.error("Failure to load actor " + id, error)
                    }
                });
            } catch (error) {
                const index = awaitingLoads.indexOf(id + "." + source);
                awaitingLoads.splice(index, 1);

                console.error("Error while loading actor " + id, error)
            }
        }






        const tileCanvas = document.createElement("canvas");
        tileCanvas.width = 480;
        tileCanvas.height = 360;
        tileCanvas.style = `image-rendering: crisp-edges;
transform-origin: top left;
transform: scale(3);
image-rendering: pixelated;`;
        document.body.appendChild(tileCanvas);
        let tileCTX = tileCanvas.getContext("2d");
        tileCTX.imageSmoothingEnabled = false;

        function drawTile(id, index, x, y) {
            const tileSize = 16; //Hardcoded for now
            const scale = 1.0; //Hardcoded for now
            const tilesetWidth = 8; //Hardcoded for now

            tileCTX.drawImage(
                assets.tiles[id].img,

                ((index - 1) % tilesetWidth) * tileSize,
                Math.floor((index - 1) / tilesetWidth) * tileSize,
                tileSize, tileSize,

                x * scale, y * scale,

                tileSize * scale, tileSize * scale
            );
        }

        function drawTileset(tileset, tiles) {
            const tileSize = 16;
            for (let i = 0; i < tiles.length; i++) {
                for (let ii = 0; ii < tiles[i].length; ii++) {
                    const currentIndex = tiles[i][ii];
                    if (currentIndex !== 0) drawTile(tileset, tiles[i][ii], ii * tileSize, i * tileSize);
                }
            }
        }

        function drawActor(id, pose, x, y) {
            const tileSize = 16; //Hardcoded for now
            const scale = 1.0; //Hardcoded for now


            const sprite = game.actors[id];

            if (!sprite) return;

            const spriteSrc = assets.actors[sprite.src];

            const shiftX = sprite.shiftX || 0;
            const shiftY = sprite.shiftY || 0;

            if (sprite.mode === "singleSprite") {

            } else if (sprite.mode === "4x4") {
                let direction = 0;
                if (typeof pose.rotation === "number") {

                    direction = get4Direction(pose.rotation);

                } else if (typeof pose.direction === "number") direction = mod(pose.direction, 4);


                let frame = 0;
                if (pose.state === "WALK") {
                    if (typeof pose.frame === "number") frame = pose.frame;
                    frame = Math.floor(mod(frame, 4))
                }


                const spriteWidth = spriteSrc.width / 4;
                const spriteHeight = spriteSrc.height / 4;

                tileCTX.drawImage(
                    spriteSrc.img,

                    spriteWidth * frame, spriteWidth * direction,

                    spriteWidth, spriteHeight,

                    ((x * scale) + 1) * tileSize - (spriteWidth * scale / 2) + shiftX,
                    ((y * scale) + 1) * tileSize - (spriteHeight * scale / 2) + shiftY,

                    spriteWidth * scale, spriteHeight * scale
                );

            }
        }


        class Actor {
            constructor(id) {
                this.id = id || undefined;

                this.x = activeScene.actors[id].x || 0;
                this.y = activeScene.actors[id].y || 0;

                this.rotation = activeScene.actors[id].rotation || undefined;

                this.sprite = activeScene.actors[id].sprite || "";

                this.script = activeScene.actors[id].script || [];

                this.state = activeScene.actors[id].state || "IDLE";
            }

            update() {

            }

            draw() {
                let myPose = {};
                if (this.rotation !== undefined) myPose.rotation = this.rotation;
                myPose.state = this.state;

                myPose.frame = frame / 10

                drawActor(this.sprite, myPose, this.x, this.y);
            }
        }


        let actors = [];


        let game;
        let activeScene;
        async function loadGame(load, func) {
            game = load;
            activeScene = structuredClone(game.scenes[0]);

            // Create a new Actor class for each actor in the load.
            actors = [];
            for (let actor in activeScene.actors) {
                actors.push(new Actor(actor));
            }

            requestAnimationFrame(gameLoop);

            if (typeof func === "function") func();
        }


        let timeOld = performance.now();
        const targetFrameRate = 60;
        const timestep = 1000 / targetFrameRate;
        let frame = 0
        function gameLoop(currentTime) {

            const dT = currentTime - timeOld;

            if (dT >= timestep) {
                timeOld = currentTime;
                gameUpdate(dT);
            }

            frame++;
            requestAnimationFrame(gameLoop);
        }


        function gameUpdate(dT) {

            drawGame();

        }

        function drawGame() {
            tileCTX.clearRect(0, 0, tileCanvas.width, tileCanvas.height);

            for (let i = 0; i < activeScene.layers.length; i++) {
                drawTileset(activeScene.layers[i].tileset, activeScene.layers[i].tiles);
            }

            for (let actor of actors) {
                actor.draw();
            }
        }


    </script>

    <script type="module">
        await initialiseTileset("src/tileset.png", "grasslands")

        await initialiseActor("src/lilguy.png", "lilguy")



        // collisions is stored what part of the directions to move accross are possible. mapping is binary with: up right left down

        // passible : number : impassible
        //          : 0      : ↓→←↑
        // ↓        : 1      : →←↑
        // →        : 2      : ↓←↑
        // ↓→       : 3      : ←↑
        // ←        : 4      : ↓→↑
        // ↓←       : 5      : →↑
        // →←       : 6      : ↓↑
        // ↓→←      : 7      : ↑
        // ↑        : 8      : ↓→←
        // ↓↑       : 9      : →←
        // →↑       : 10     : ↓←
        // ↓→↑      : 11     : ←
        // ←↑       : 12     : ↓→
        // ↓←↑      : 13     : →
        // →←↑      : 14     : ↓
        // ↓→←↑     : 15     :



        await loadGame({
            tilesets: {
                "grasslands": {
                    src: "grasslands",
                    mode: "tileset",
                    size: 16,
                    width: 8,
                    collisions: [
                        [
                            [3, 7, 5, 0],
                            [11, 15, 13],
                            [10, 14, 12],
                            [0, 0, 0],
                            [0, 0, 0]
                        ]
                    ]
                }
            },
            actors: {
                "lilguy": {
                    src: "lilguy",
                    mode: "4x4",
                    shiftY: -8
                }
            },
            scripts: {
                "lilguy": {
                    language: "parscript",
                    script: `

turn(180)

say("Hello adventurer!")

wait(5)

turn(0)

wait(60)

turn(180)


ask("Have you played before?", "Yes", "No"){
    say("Great!")
} & {
    say("I'll show you the ropes!")

    #tutorial()
}
                    `
                }
            },
            scenes: [
                {
                    width: 10,
                    height: 10,
                    scale: 16,
                    layers: [
                        {
                            tileset: "grasslands",
                            tiles: [
                                [1, 2, 2, 2, 2, 3],
                                [9, 10, 10, 10, 10, 11],
                                [17, 18, 18, 18, 18, 19],
                                [25, 26, 26, 26, 26, 27],
                                [25, 26, 26, 26, 26, 27],
                                [25, 26, 26, 26, 26, 27],
                                [33, 34, 34, 34, 34, 35],
                                [10, 10, 10, 10, 10, 10],
                                [10, 10, 10, 10, 10, 10],
                                [10, 10, 10, 10, 10, 10]
                            ]
                        },
                        {
                            tileset: "grasslands",
                            tiles: [
                                [0],
                                [0, 0, 0, 4]
                            ]
                        }
                    ],
                    actors: {
                        "lilguy": {
                            sprite: "lilguy",
                            rotation: 0,
                            x: 1,
                            y: 1,
                            trigger: "load",
                            script: "lilguy"
                        },
                        "lilguy2": {
                            sprite: "lilguy",
                            rotation: 90,
                            x: 2,
                            y: 1
                        }
                    }
                }
            ]
        },
            () => {
            })
    </script>
</body>

</html>